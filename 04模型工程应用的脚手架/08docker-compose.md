## Docker Compose：多容器服务的“乐队指挥”

上一期我们学习了 Docker，它让我们能够高效地运行一个独立的应用程序。但在实际的工程中，我们的平台（比如能管系统）绝不是一个单独的服务，它是由多个组件构成的：前端 Web 界面、后端 API 服务、数据库、缓存等等。

这时候，如果用手敲 `docker run` 命令来管理这五六个容器，不仅效率低下，而且极易出错。**Docker Compose** 正是为解决这个问题而生的。

-----

### 一、核心思想：将服务视为整体（集装箱货轮）

如果说单个 Docker 容器是一个集装箱，那么 **Docker Compose 就是一艘巨大的集装箱货轮**，它负责装载、管理和调度所有这些集装箱（服务）。

我们不再将应用视为一堆独立的容器，而是视为一个**整体的服务栈（Service Stack）**。

#### 银行系统的类比（服务编排）

我们可以用银行系统来理解这种服务编排：

  * **单个容器（Docker）：** 就像银行里的一个柜员，只能独立处理一项业务（比如只负责数据库操作）。
  * **Docker Compose：** 就像一个分行经理，它能同时启动、连接和管理所有组件。
      * **堡垒机（Nginx/Proxy 容器）：** 像银行大堂里的自动取款机（ATM），它是用户接触到的第一层，负责接收请求，并将请求安全地转发给后端的服务员。
      * **后端服务容器：** 像后端的专业柜员，比如一个处理用户业务，另一个处理财务计算。

> Docker Compose 的作用就是用一份配置文件，定义整个银行分行（我们的平台）的全部架构。

-----

### 二、Docker Compose 的核心：YAML 配置文件

Docker Compose 所有的魔力都集中在一个名为 **`docker-compose.yml`** 的配置文件中。它是一个 **YAML 格式**的文件，用声明式的方式描述了我们的应用栈。

这份配置文件主要定义了三个核心元素：

1.  **Services（服务）：** 定义了应用中的每一个独立组件。比如 `web`、`db`、`cache`。
2.  **Networks（网络）：** 定义了这些服务如何相互通信。Compose 会自动为所有服务创建一个**私有内部网络**，让它们能通过**服务名**互相访问（例如，`web` 服务可以直接通过主机名 `db` 访问数据库）。
3.  **Volumes（卷）：** 定义了用于持久化存储的目录。

#### YAML 配置文件的关键指令

在 `services` 部分，我们需要对每个容器定义以下关键参数：

| YAML 指令 | 容器指令（Docker Run）的对应关系 | 作用 |
| :--- | :--- | :--- |
| `image: <name>` | 无对应选项，直接指定镜像 | 指定该服务使用的基础镜像。 |
| `build: .` | `docker build` | 指定从本地的 Dockerfile 构建镜像。 |
| `ports: ['8080:80']` | `-p 8080:80` | 定义端口映射，将宿主机端口暴露给外部。 |
| `volumes: ['/local:/cont']` | `-v /local:/cont` | 定义目录挂载，实现数据持久化或配置共享。 |
| `environment:` | `-e` | 设置容器内部的环境变量（如数据库密码）。 |
| `depends_on:` | 无对应，Compose 特有 | 依赖关系。确保某个服务（如数据库）启动并就绪后，另一个服务（如后端 API）才启动。 |

-----

### 三、常用 Docker Compose 命令

使用 Docker Compose，你可以用一个命令启动和停止整个应用栈：

  * **启动应用栈（最常用）：**

<!-- end list -->

```bash
# 在包含 docker-compose.yml 文件的目录下运行
# -d 表示在后台（Detached）运行所有容器
docker-compose up -d
```

  * **查看服务状态：**

<!-- end list -->

```bash
# 查看所有服务及其容器的状态
docker-compose ps
```

  * **查看日志：**

<!-- end list -->

```bash
# 查看所有服务的实时日志
docker-compose logs -f
```

  * **停止并删除容器和网络：**

<!-- end list -->

```bash
# 停止所有容器，并移除容器和自动创建的网络
docker-compose down
```

-----

### 总结：从孤岛到群落

从单个的 `docker run` 命令到 Docker Compose，我们完成了从管理独立容器孤岛到管理**协同工作的容器群落**的转变。

Docker Compose 是我们实现本地开发、测试和小型生产部署的利器，它保证了整个应用栈环境的一致性和可重复性。