## 从虚拟机到容器化：Docker 核心实践

大家好。在前面的课程中，我们使用了 WSL 或是 VirtualBox 来运行完整的 Linux 操作系统。虽然这比在物理机上安装方便得多，但它仍然需要虚拟机软件，并在其中运行一个完整的操作系统内核和全部系统服务，这消耗了大量的内存和磁盘空间。

为了解决这个问题，技术进一步发展，诞生了\*\*容器化（Containerization）\*\*技术。它是现代工程部署的基石，而 **Docker** 就是这场革命的代表。

-----

### 一、容器化的本质：轻量级虚拟化

很多人将容器称为\*\*“轻量级的虚拟机”\*\*，但这并不完全准确。容器的核心思想是：**共享宿主机内核**。

  * **虚拟机 (VM)：** 模拟完整的硬件，并在其上运行一个独立的操作系统（OS），拥有自己的内核。
  * **容器 (Container)：** **共享宿主机（Host）的内核**，通过 Linux 的 Cgroups 和 Namespaces 技术进行资源隔离和进程隔离。

这种共享内核的方式，使得容器具有以下巨大优势：

  * **极速启动：** 容器启动速度极快，通常在秒级甚至毫秒级，因为它们不需要引导整个操作系统。
  * **资源高效：** 容器只打包应用及其依赖，文件体积极小，对内存和 CPU 的占用也远低于虚拟机。
  * **环境一致：** 容器将应用运行所需的所有环境打包在一起，彻底解决了“在我机器上能运行，在你机器上就报错”的环境依赖问题。

-----

### 二、Docker 核心概念：镜像、容器与仓库

理解 Docker，要从理解三个核心概念开始：**镜像、容器和镜像仓库**。

#### 1\. 镜像（Image）：容器的“只读模板”

容器镜像就像是一个只读的模板或软件快照。它包含了运行应用所需的所有代码、运行时环境、库文件、环境变量和配置文件。

  * **分层存储（洋葱模型）：** 镜像不是一个巨大的文件。为了节省空间和加速传输，Docker 采用了联合文件系统（Union File System）。镜像由一系列**只读的层（Layers）堆叠而成，就像洋葱一样。当你安装一个软件时，Docker 只会存储该软件新增的文件，也就是增量（Delta）**，而不是重复存储整个系统。这使得不同的镜像可以共享相同的底层层。

#### 2\. 容器（Container）：镜像的“运行实例”

容器是镜像的运行实例。当你从一个镜像启动一个容器时，Docker 会在该镜像的顶部再叠加一个**可读写的层**。

  * 你在容器内做的任何修改，都会发生在这一层。容器可以被启动、停止、删除，但镜像本身保持不变。

#### 3\. 镜像仓库（Registry）：集中托管中心

镜像仓库是用于集中托管、分享和拉取容器镜像的地方。

  * 最著名的公有仓库是 **Docker Hub**。
  * 在企业部署中，通常会使用私有的 **Harbor** 等仓库来安全地存储内部的定制镜像。

-----

### 三、Docker 基础操作：构建、拉取与运行

#### 1\. 如何构建镜像：Dockerfile

镜像不是凭空产生的，它们是根据一个名为 **Dockerfile** 的文本文件构建的。Dockerfile 就是一份镜像的构建说明书，它包含了构建镜像所需的所有步骤和命令。

**基本操作：**

```bash
# 在包含 Dockerfile 的目录下执行
docker build -t <镜像名称>:<标签/版本号> . 

# 示例：构建一个名为 my_nginx 的镜像
docker build -t my_nginx:v1 . 
```

#### 2\. 如何拉取和推送镜像

  * **拉取镜像：** 从远程仓库下载镜像到本地。

<!-- end list -->

```bash
# 从 Docker Hub 拉取官方 NGINX 镜像的最新稳定版本
docker pull nginx:latest
```

  * **推送镜像：** 将本地构建的镜像上传到远程仓库。

<!-- end list -->

```bash
# 首先需要登录到远程仓库
docker login

# 推送镜像
docker push <用户名>/<镜像名称>:<标签>
```

#### 3\. 运行容器

运行容器是 Docker 最常用的命令。

```bash
# 运行容器
docker run [选项] <镜像名称> [运行命令]
```

#### 4\. 进入已运行的容器

要对容器进行调试或查看内部文件，你需要进入其命令行环境。

```bash
# 使用 exec 命令进入一个已运行的容器
# -it 选项非常重要：-i 保持输入流打开，-t 分配一个伪终端
docker exec -it <容器ID或名称> /bin/bash
```

-----

### 四、部署实战核心：网络与存储

在部署我们的平台时，最关键的两个配置就是端口映射和目录挂载。

#### 1\. 端口映射（网络）

容器拥有自己的内部网络。要让外部（宿主机、互联网）访问容器内部运行的服务（如 NGINX 的 80 端口），你需要进行**端口映射**。

  * `-p <宿主机端口>:<容器内部端口>`

<!-- end list -->

```bash
# 示例：运行 NGINX 容器，将宿主机的 8080 端口映射到容器内部的 80 端口
docker run -d -p 8080:80 --name my_web_server nginx

# 解释：宿主机（你的电脑）访问 8080 端口，就会转发到容器的 80 端口
```

#### 2\. 目录挂载（存储）

容器在被删除时，内部的可读写层也会随之消失，数据无法持久化。为了保存数据、日志或配置文件，我们需要将宿主机（Host）的目录\*\*挂载（Volume Mount）\*\*到容器内部。

  * `-v <宿主机路径>:<容器内部路径>`

<!-- end list -->

```bash
# 示例：将宿主机本地的 /home/user/nginx_conf 目录挂载到容器的 NGINX 配置目录
docker run -d -p 8080:80 \
           -v /home/user/nginx_conf:/etc/nginx/conf.d \
           --name my_conf_server nginx

# 解释：这样你就可以在宿主机上修改配置文件，容器内部会实时同步，且容器删除后配置依然保留。
```

掌握了 Docker 的这几个核心概念和命令，你就掌握了现代工程部署最强大的工具。容器化是我们平台实现高效、可移植部署的关键。